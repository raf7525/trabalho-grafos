<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Grafo Recife</title>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; height: 100vh; overflow: hidden; }
        #container-grafo { width: 100%; height: calc(100vh - 80px); }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <header class="bg-gray-800 border-b border-gray-700 px-4 py-3 flex flex-wrap gap-3 items-center">
        <span class="font-bold text-lg">WAZE</span>
        <select id="algoritmo" class="px-3 py-1 bg-gray-700 border border-gray-600 rounded text-sm">
            <option value="bfs">BFS</option>
            <option value="dijkstra">Dijkstra</option>
            <option value="bellman">Bellman-Ford</option>
            <option value="dfs">DFS</option>
        </select>
        <span class="text-gray-500">|</span>
        <select id="origem" class="px-3 py-1 bg-gray-700 border border-gray-600 rounded text-sm">
            <option disabled selected>Origem...</option>
        </select>
        <span class="text-gray-500">→</span>
        <select id="destino" class="px-3 py-1 bg-gray-700 border border-gray-600 rounded text-sm">
            <option disabled selected>Destino...</option>
        </select>
        <button onclick="executar()" class="px-4 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm font-medium">
            Executar
        </button>
        <button onclick="limpar()" class="px-4 py-1 bg-gray-600 hover:bg-gray-700 rounded text-sm">
            Limpar
        </button>
        <button onclick="rotaPDF()" class="px-4 py-1 bg-yellow-600 hover:bg-yellow-700 rounded text-sm ml-auto">
            Rota PDF
        </button>
    </header>

    <div id="container-grafo" class="bg-gray-800"></div>
    
    <div id="info" class="hidden fixed bottom-5 left-5 bg-gray-800 border border-gray-600 rounded-lg p-4 max-w-sm shadow-xl">
        <h3 id="info-title" class="text-lg font-bold mb-2"></h3>
        <div id="info-stats" class="text-sm mb-3"></div>
        <div id="info-path" class="text-xs overflow-y-auto max-h-24 text-gray-300"></div>
    </div>

    <div id="toast" class="hidden fixed top-5 right-5 px-4 py-3 rounded-lg shadow-lg text-white"></div>

    <script>
        const API_URL = '/api/calcular';
        const COLORS = {
            dijkstra: '#FF7A00',
            bfs: '#FFB784',
            bellman: '#FFBC7D',
            dfs: '#FFA500',
            start: '#00ff00',
            end: '#ff0000'
        };

        let network, nodes, edges, nodeMap = {}, edgeMap = {};

        fetch('./grafo_dados.json')
            .then(r => r.json())
            .then(init)
            .catch(() => notificar('Erro ao carregar grafo', 'error'));

        function init(data) {
            nodes = new vis.DataSet(data.nodes);
            edges = new vis.DataSet(data.edges);
            
            data.nodes.forEach(n => nodeMap[n.id] = n);
            data.edges.forEach(e => {
                edgeMap[e.from] = edgeMap[e.from] || {};
                edgeMap[e.to] = edgeMap[e.to] || {};
                edgeMap[e.from][e.to] = e.id;
                edgeMap[e.to][e.from] = e.id;
            });

            popularSelects(data.nodes);
            criarGrafo();
        }

        function popularSelects(nodeList) {
            const sorted = [...nodeList].sort((a,b) => a.label.localeCompare(b.label));
            const selectOrigem = document.getElementById('origem');
            const selectDestino = document.getElementById('destino');
            
            sorted.forEach(n => {
                selectOrigem.add(new Option(n.label, n.id));
                selectDestino.add(new Option(n.label, n.id));
            });
        }

        function criarGrafo() {
            network = new vis.Network(
                document.getElementById('container-grafo'),
                { nodes, edges },
                {
                    nodes: { shape: 'dot', font: { color: 'white' }, borderWidth: 2 },
                    edges: { color: { color: '#666', opacity: 0.2 }, width: 1, smooth: { type: 'continuous' } },
                    physics: { stabilization: { iterations: 100 }, barnesHut: { gravitationalConstant: -4000 } }
                }
            );
        }

        function executar() {
            const selectOrigem = document.getElementById('origem');
            const selectDestino = document.getElementById('destino');
            const selectAlgoritmo = document.getElementById('algoritmo');
            
            if (
            !selectOrigem.value 
            || !selectDestino.value 
            || selectOrigem.value.includes('...') 
            || selectDestino.value.includes('...')
            ) return notificar('Selecione origem e destino', 'warning');
            
            resetarVisual();
            
            (async () => {
                try {
                    const params = new URLSearchParams({
                        alg: selectAlgoritmo.value,
                        origem: selectOrigem.value,
                        destino: selectDestino.value
                    });
                    const url = `${API_URL}?${params.toString()}`;

                    const response = await fetch(url);
                    const data = await response.json();

                    if (!response.ok) throw data;

                    destacarCaminho(data.caminho, data.algoritmo, data.custo);
                } catch (err) {
                    notificar(err.erro);
                }
            })();
        }

        function destacarCaminho(caminho, alg, custo) {
            const cor = COLORS[alg.toLowerCase()] || COLORS.dijkstra;
            
            nodes.update(caminho.map((id, i) => ({
                id,
                color: { 
                    background: i === 0 ? COLORS.start : i === caminho.length - 1 ? COLORS.end : cor,
                    border: '#fff'
                },
                size: 30,
                font: { size: 16, background: '#000' }
            })));

            const arestasAtualizadas = [];
            for (let i = 0; i < caminho.length - 1; i++) {
                const edgeId = edgeMap[caminho[i]]?.[caminho[i+1]];
                if (edgeId) arestasAtualizadas.push({ id: edgeId, color: { color: cor, opacity: 1 }, width: 4 });
            }
            edges.update(arestasAtualizadas);

            network.fit({ nodes: caminho, animation: true });
            mostrarInfo(alg, custo, caminho);
        }

        function mostrarInfo(alg, custo, caminho) {
            const panelInfo = document.getElementById('info');
            const titulo = document.getElementById('info-title');
            const stats = document.getElementById('info-stats');
            const path = document.getElementById('info-path');
            
            panelInfo.classList.remove('hidden');
            titulo.textContent = `${alg} (Python)`;
            stats.innerHTML = `Custo: <b>${custo}</b> | Nós: <b>${caminho.length}</b>`;
            path.textContent = caminho.map(id => nodeMap[id].label).join(' → ');
        }

        function notificar(msg, tipo = 'error') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = `fixed top-5 right-5 px-4 py-3 rounded-lg shadow-lg text-white ${
                tipo === 'error' ? 'bg-red-600' : 'bg-yellow-600'
            }`;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        function resetarVisual() {
            nodes.update(nodes.getIds().map(id => ({
                id,
                color: null,
                size: nodeMap[id].value || 20,
                font: { size: 14, background: 'transparent' }
            })));
            edges.update(edges.getIds().map(id => ({
                id,
                color: { color: '#666', opacity: 0.2 },
                width: 1
            })));
            info.classList.add('hidden');
        }

        function limpar() {
            resetarVisual();
            origem.value = destino.value = 'Origem...';
            network.fit();
        }

        function rotaPDF() {
            origem.value = 'nova descoberta';
            destino.value = 'boa viagem';
            algoritmo.value = 'dijkstra';
            executar();
        }
    </script>
</body>
</html>